---
layout: single
title:  "Docker를 활용한 가상머신서버만들기"
---

# Docker

## 구조
Hub -- Image -- Container  
  pull    run

docker images --list  
docker pull  
docker password  
docker start  
docker stop  
docker rmi 이미지명  
docker rm (--force) 컨테이너명  
docker logs -f 이름  
docker run 80:80 이미지명  


# Kubernetes

Hyperviser = VMWare, Hiper-V

- 쿠버네티스(K8s)  
그리스어로 조타수  
컨테이너화된 애플리케이션을 자동으로 배포  
스케일링 및 관리해주는 오픈소스 시스템  
구글 제작
멀티호스트 도커 플랫폼  
도커가 돌아가는 서버를 여러대로  
서버가 많아지다보니 많은 컨테이너를 컨트롤하기 어려움  
컨테이너 오케스트레이션 -  
서버1 - control plane(지휘자)  
서버2 - worker node1  
서버3 - worker node2  

계층|명칭|플랫폼
:--|:--:|:--
Layer6|Development Workflow Opinionated Containers|OpenShift, **Docker Cloud**, Cloud Foundary, Deis
Layer5|Orchestration/Scheduling Service Model|**Kubernetes**, Docker Swarm, Nomad, Diago
Layer4|Container Engine|**Docker**, Rocket, RunC, Osv
Layer3|Operating System|Ubuntu, RHEL, CoreOS
Layer2|Virtual Infrastructure|vSphere, EC2, GCP, Azure
Layer1|Physical Infrastructure|Raw Computer, Network, Storage

- 특징  
선언적 API - 서버 3개 실행해줘 하면 명령  
모니터링 하고 서버상태를 봐가며 웹서버 3개실행시킴


## 설치없이 실습하기

[쿠버네티스 플레이그라운드 접속](https://labs.play-with-k8s.com)  
깃 혹은 도커계정으로 가입한 후 4시간동안 쓸수 있음  

실행되고 나면 먼저 인스턴스 생성

1. Initializes cluster master node:

 kubeadm init --apiserver-advertise-address $(hostname -i) --pod-network-cidr 10.5.0.0/16
    

 2. Initialize cluster networking:

kubectl apply -f https://raw.githubusercontent.com/cloudnativelabs/kube-router/master/daemonset/kubeadm-kuberouter.yaml


 3. (Optional) Create an nginx deployment:

 kubectl apply -f https://raw.githubusercontent.com/kubernetes/website/master/content/en/examples/application/nginx-app.yaml



 1 번을 수행하면 아래와 같이 차일드서버가 조인하는 명령정보나 출력된다.

 kubeadm join 192.168.0.8:6443 --token 4cwzyy.fxhhufzbsmczxnch \
    --discovery-token-ca-cert-hash sha256:2f09bc138785e6abe268a0f2c9ecacb12575761b6ea09f785500adb5114155f0  

이후 2번 명령어를 수행한다.  

2번도 완료되면 새로운 인스턴스를 생성하여 1번에서나온 조인 명령어를 수행한다.  
차일드 서버를 늘리려면 인스턴스를 추가로 생성하여 똑같이 명령어를 수행한다.

다시 마스터서버로 넘어와 "kubectl get nodes -o wide" 명렁어를 실행하면 연결된서버정보가 나온다.


## 쿠버네티스 직접설치하여 사용하기

CNI(Container Network Interface)
컨테이너간에 통신지원하는 인터페이스 받드시설치해야 통신이가능함  
다양한 솔루션이있음 플라넬, 칼리코, **위브넷**, 큐브라우터  

## 쿠버네티스 클러스터 구성
- control plane(master node)
  - 워커 노드들의 상태를 관리제어
  - single master
  - multi master(3,5개등)
- worker node
  - 도커 플랫폼을 통해 컨테이너를 동작하며 실제서비스 제공



- 가상머신 설치
  - 마스터 : 우분투 core=2,ram=2g,storage=32g, kube_master/기본***
    - 마스터에만 ui설치
    - $ sudo apt update
    - $ sudo apt install tasksel
    - $ sudo tasksel install ubuntu-desktop
    - $ sudo apt-get install --no-install-recommends ubuntu-desktop
    - $ sudo reboot
  - 워커 : 우분투 core=1,ram=1g,storage=32g, kube_worker/기본***
  - $ sudo apt-get install indicator-appmenu-tools (hud service not connected 오류 해결)


64.6 : master
64.4 : worker
64.7 : worker_sub



- Docker install
  - https://docs.docker.com/engine/install/ubuntu/
    - sudo apt-get update
    - sudo apt-get install \
      ca-certificates \
      curl \
      gnupg \
      lsb-release
    - sudo mkdir -p /etc/apt/keyrings
    - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    - echo \
      "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
      $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
    - sudo apt-get update
    - sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin
    - apt-cache madison docker-ce    "여기서 버전확인후 아래입력"
    - sudo apt-get install docker-ce=<VERSION_STRING> docker-ce-cli=<VERSION_STRING> containerd.io docker-compose-plugin
    - sudo docker run hello-world
    - systemctl enable docker
    - systemctl start docker
    - docker version


- Kubernetes install
  - 환경설정
    - swapoff -a && sed -i '/swap/s/^/#/' /etc/fstab
    - cat <<EOF > /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
    - sysctl --system
    - systemctl stop firewalld
    - systemctl disable firewalld
  - kubeadm(커맨드), kubectl(데몬), kubelet(명령어유틸) 설치
    - https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/
    - apt-get update
    - apt-get install -y apt-transport-https ca-certificates curl
    - curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg
    - echo "deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee /etc/apt/sources.list.d/kubernetes.list
    - apt-get update
    - apt-get install -y kubelet kubeadm kubectl
    - apt-mark hold kubelet kubeadm kubectl
    - systemctl start kubelet
    - systemctl enable kubelet
  - control-plane 구성
    - <마스터> kubeadm init
      - 오류발생시
        - rm /etc/containerd/config.toml
        - systemctl restart containerd
        - kubeadm init
      - 오류발생시(
        - echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward
    - mkdir -p $HOME/.kube
    - cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
    - chown $(id -u):$(id -g) $HOME/.kube/config
  - worker node 구성
  - 설치확인

- Linux root Setting
  - sudo passwd root -> root 암호설정
  - su - -> root 로그인
  - 인증 후 su 권한으로 사용


sudo apt-get install docker-ce=5:20.10.17~3-0~ubuntu-jammy docker-ce-cli=5:20.10.17~3-0~ubuntu-jammy containerd.io docker-compose-plugin